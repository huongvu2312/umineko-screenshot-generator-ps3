<!DOCTYPE html>
<html>
<head>
    <title>Umineko Screenshot Generator</title>
    <style>
        body {
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
        }
        .section {
            display: none;
        }
        .active {
            display: block;
        }

        #generateSection {
            position: relative;
        }

        @font-face {
            font-family: SazanamiGothic;
            src: url("assets/font/sazanami-gothic.ttf");
        }

    </style>

    <script src="sprite_map.js"></script>
    <script src="background_list.js"></script>
    <script>

        var left = "";
        var center = "";
        var right = "";
        var bg = "";

        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                const allSections = document.querySelectorAll('.section');
                allSections.forEach((sec) => sec.classList.remove('active'));
                section.classList.add('active');
            }
        }

        function load_thumbnails(data) {
            let thumbnail = [];

            for (const key in data) {
                if (data.hasOwnProperty(key) && Array.isArray(data[key]) && data[key].length > 0) {
                    const firstImagePath = data[key][0];
                    thumbnail.push([key, firstImagePath]);
                }
            }

            return thumbnail
        }

        function load_images(key, position, id) {

            const imagesContainer = document.getElementById(id);

            while (imagesContainer.firstChild) {
                imagesContainer.removeChild(imagesContainer.firstChild);
            }

            let currentSprite = spriteMap[key]

            for (let i = 0; i < currentSprite.length; i++) {

                const imgElement = document.createElement("img");

                imgElement.src = currentSprite[i]

                imgElement.style.objectFit = "cover";
                imgElement.style.objectPosition = "center center";
                imgElement.style.width = "100px";
                imgElement.style.height = "100px";
                imgElement.style.margin = "5px";
                imgElement.style.border = "2px solid"
                imgElement.onclick = function() {
                    if (position === "left") {
                        left = currentSprite[i]
                    } else if (position === "center") {
                        center = currentSprite[i]
                    } else if (position === "right") {
                        right = currentSprite[i]
                    }
                }

                imagesContainer.appendChild(imgElement);
            }
        }


        function createThumbnails(map, position, id, imageId) {
            const thumbnailsContainer = document.getElementById(id);
            let sprites = load_thumbnails(map)

            for (let i = 0; i < sprites.length; i++) {
                const sprite = sprites[i];
                const spriteName = sprite[0];
                const spritePath = sprite[1];

                const imgElement = document.createElement("img");

                imgElement.src = spritePath;

                imgElement.style.objectFit = "cover";
                imgElement.style.objectPosition = "center center";
                imgElement.style.width = "100px";
                imgElement.style.height = "100px";
                imgElement.style.margin = "5px";
                imgElement.style.border = "2px solid"

                imgElement.onclick = function () {
                    load_images(spriteName, position, imageId)
                }

                thumbnailsContainer.appendChild(imgElement);
            }
        }

        function loadBackgrounds() {
            const backgroundsContainer = document.getElementById("backgroundsContainer");

            for (let i = 0; i < backgroundList.length; i++) {
                const background = backgroundList[i];

                const imgElement = document.createElement("img");

                imgElement.src = background;

                imgElement.style.objectFit = "cover";
                imgElement.style.objectPosition = "center center";
                imgElement.style.maxWidth = "300px";
                imgElement.style.maxHeight = "300px";
                imgElement.style.margin = "5px";
                imgElement.style.border = "2px solid"
                imgElement.onclick = function() {
                    bg = background
                }

                backgroundsContainer.appendChild(imgElement);
            }
        }

        function generate() {
            const textOverlay = document.getElementById("text-overlay");
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const background = new Image();
            background.src = bg
            const leftImage = new Image();
            leftImage.src = left
            const rightImage = new Image();
            rightImage.src = right
            const centerImage = new Image();
            centerImage.src = center

            let font = new FontFace('SazanamiGothic', 'url(./assets/font/sazanami-gothic.ttf)');
            font.load().then(function(loaded_face) {
                document.fonts.add(loaded_face);
            }).catch(function(error) {
                console.log(error)
            });

            Promise.all([
                loadImageAsync(bg),
                loadImageAsync(left),
                loadImageAsync(center),
                loadImageAsync(right),
            ]
            )
                .then(([bgImage, leftImage, centerImage, rightImage]) => {
                    ctx.filter = "brightness(60%)";
                    ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);

                    if (centerImage) {
                        const scaleFactor = 1.2;
                        const centerImageWidth = centerImage.width * scaleFactor;
                        const centerImageHeight = centerImage.height * scaleFactor;
                        const centerImageX = canvas.width / 2 - centerImageWidth / 2;
                        const centerImageY = canvas.height - centerImageHeight + 50;
                        ctx.drawImage(centerImage, centerImageX, centerImageY, centerImageWidth, centerImageHeight);
                    }

                    if (leftImage) {
                        const scaleFactor = 1.2;
                        const leftImageWidth = leftImage.width * scaleFactor;
                        const leftImageHeight = leftImage.height * scaleFactor;
                        const leftImageX = canvas.width - leftImageWidth - 350;
                        const leftImageY = canvas.height - leftImageHeight + 50;
                        ctx.drawImage(leftImage, leftImageX, leftImageY, leftImageWidth, leftImageHeight);
                    }

                    if (rightImage) {
                        const scaleFactor = 1.2;
                        const rightImageWidth = rightImage.width * scaleFactor;
                        const rightImageHeight = rightImage.height * scaleFactor;
                        const rightImageX = canvas.width - rightImageWidth + 50;
                        const rightImageY = canvas.height - rightImageHeight + 50;
                        ctx.drawImage(rightImage, rightImageX, rightImageY, rightImageWidth, rightImageHeight);
                    }

                    ctx.globalAlpha = 1;
                    ctx.filter = "none";
                    ctx.font = "24px SazanamiGothic";

                    const textX = 50;
                    const textY = 70;
                    const maxTextWidth = 750;
                    const lineHeight = 40;
                    const text = document.getElementById("text").value;
                    wrapText(ctx, text, textX, textY, maxTextWidth, lineHeight);
                })
                .catch(error => {
                    console.log("ERRRORRR");
                });

        }

        function loadImageAsync(url) {
            return new Promise((resolve, reject) => {
                if (url !== "") {
                    const image = new Image();
                    image.onload = () => resolve(image);
                    image.onerror = reject;
                    image.src = url;
                } else {
                    resolve(null);
                }
            });
        }

        function loadImage(image) {
            return new Promise((resolve, reject) => {
                image.onload = () => resolve(image);
                image.onerror = (error) => reject(error);
            });
        }

        function loadFont(font) {
            return new Promise((resolve, reject) => {
                font.onload = () => resolve(font);
                font.onerror = (error) => reject(error);
            });
        }
        function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
            const colorCodes = {
                red: "#ff0000",
                blue: "#5decff",
                golden: "#ffcc00",
            };

            const regex = /\[(\w+)\](.*?)\[\/\w+\]/g;
            let match;
            let currentX = x;
            let currentY = y;

            while ((match = regex.exec(text)) !== null) {
                const [fullMatch, color, content] = match;
                const textColor = colorCodes[color] || "white";

                const words = content.split(" ");
                let line = "";

                for (let i = 0; i < words.length; i++) {
                    const testLine = line + words[i] + " ";
                    const metrics = ctx.measureText(testLine);
                    const testWidth = metrics.width;

                    if (currentX + testWidth > x + maxWidth) {
                        ctx.fillStyle = textColor;
                        ctx.fillText(line, currentX, currentY);
                        currentY += lineHeight;
                        line = words[i] + " ";
                        currentX = x;
                    } else {
                        line = testLine;
                    }
                }

                ctx.fillStyle = textColor;
                ctx.fillText(line, currentX, currentY);

                if (currentX + ctx.measureText(line).width > x + maxWidth) {
                    currentY += lineHeight;
                    currentX = x;
                } else {
                    currentX += ctx.measureText(line).width;
                }
            }
        }
    </script>
</head>
<body>
<h1>Umineko Screenshot Generator</h1>

<button onclick="toggleSection('backgroundSection')">Background</button>
<button onclick="toggleSection('textSection')">Text</button>
<button onclick="toggleSection('leftSpriteSection')">Left Sprite</button>
<button onclick="toggleSection('centerSpriteSection')">Center Sprite</button>
<button onclick="toggleSection('rightSpriteSection')">Right Sprite</button>
<button onclick="toggleSection('metaWorldLeftSection')">Meta World Left</button>
<button onclick="toggleSection('metaWorldCenterSection')">Meta World Center</button>
<button onclick="toggleSection('metaWorldRightSection')">Meta World Right</button>
<button onclick="toggleSection('customSprite0Section')">Custom Sprite 0</button>
<button onclick="toggleSection('customSprite1Section')">Custom Sprite 1</button>
<button onclick="toggleSection('addSpriteSection')">Add Sprite</button>
<button onclick="toggleSection('generateSection')">Generate</button>
<section id="backgroundSection" class="section">
    <h2>Background Section</h2>

    <div id="backgroundsContainer"></div>
    <script>
        loadBackgrounds()
    </script>
</section>

<div id="textSection" class="section">
    <h2>Text Section</h2>
    <textarea rows="4" cols="50" id="text"></textarea>
</div>

<section id="leftSpriteSection" class="section">
    <h2>Choose Character:</h2>
    <div id="leftThumbnailsContainer">
    </div>

    <h2>Choose Variation:</h2>
    <div id="leftImagesContainer">

    </div>
    <script>
        createThumbnails(spriteMap, "left", "leftThumbnailsContainer", "leftImagesContainer")
    </script>
</section>

<section id="centerSpriteSection" class="section">
    <h2>Choose Character:</h2>
    <div id="centerThumbnailsContainer">
    </div>

    <h2>Choose Variation:</h2>
    <div id="centerImagesContainer">

    </div>
    <script>
        createThumbnails(spriteMap, "center", "centerThumbnailsContainer", "centerImagesContainer")
    </script>
</section>

<section id="rightSpriteSection" class="section">
    <h2>Choose Character:</h2>
    <div id="rightThumbnailsContainer">
    </div>

    <h2>Choose Variation:</h2>
    <div id="rightImagesContainer">

    </div>
    <script>
        createThumbnails(spriteMap, "right", "rightThumbnailsContainer", "rightImagesContainer")
    </script>
</section>

<div id="generateSection" class="section">
    <h2>Generate</h2>
    <button onclick="generate()">Generate</button>
    <canvas id="canvas" width="800" height="600"></canvas>
</div>

</body>
</html>